var canvas=document.createElement("canvas"),ctx=canvas.getContext("2d"),imgData,currentImg,config={scale:.3,roughness:0,metalness:1,projection:"orthographic",depthOfField:4,lockY:!1,move:!0,sameColor:!1,color:"#777",colorContrast:1.2,lightIntensity:1,lightColor:"#fff",lightRotate:30,lightPitch:40,AO:1.5,showEnvironment:!1,barNumber:80,barBevel:.18,barSize:1.2};option={tooltip:{},backgroundColor:"#000",xAxis3D:{type:"value"},yAxis3D:{type:"value"},zAxis3D:{type:"value",min:0,max:100},grid3D:{show:!1,viewControl:{projection:"perspective",alpha:45,beta:-45,panSensitivity:config.move?1:0,rotateSensitivity:config.lockY?[1,0]:1,damping:.9,distance:60},postEffect:{enable:!0,bloom:{intensity:.2},screenSpaceAmbientOcclusion:{enable:!0,intensity:1.5,radius:5,quality:"high"},screenSpaceReflection:{enable:!0},depthOfField:{enable:!0,blurRadius:config.depthOfField,fstop:10,focalDistance:55}},boxDepth:100,boxHeight:20,environment:"none",light:{main:{shadow:!0,intensity:2},ambientCubemap:{texture:"/asset/get/s/data-1491838644249-ry33I7YTe.hdr",exposure:2,diffuseIntensity:.2,specularIntensity:1.5}}}};function updateData(e,t,o){console.time("update");var a=[],h={getItem:function(n){var r=e[n*4],s=e[n*4+1],l=e[n*4+2],i=.2125*r+.7154*s+.0721*l;return i=(i-125)*config.scale+50,a[0]=n%t,a[1]=o-Math.floor(n/t),a[2]=i,a},count:function(){return e.length/4}};myChart.setOption({grid3D:{boxWidth:100/o*t},series:[{animation:!1,type:"bar3D",shading:"realistic",realisticMaterial:{roughness:config.roughness,metalness:config.metalness},barSize:config.barSize,bevelSize:config.barBevel,silent:!0,itemStyle:{color:config.sameColor?config.color:function(n){var r=n.dataIndex,s=e[r*4]/255,l=e[r*4+1]/255,i=e[r*4+2]/255,d=.2125*s+.7154*l+.0721*i;return s*=d*config.colorContrast,l*=d*config.colorContrast,i*=d*config.colorContrast,[s,l,i,1]}},data:h}]}),console.timeEnd("update"),setTimeout(function(){myChart.getZr().refresh()},100)}function loadImage(e){var t=canvas.height=Math.min(config.barNumber,e.height),o=e.width/e.height,a=canvas.width=Math.round(t*o);ctx.drawImage(e,0,0,a,t),imgData=ctx.getImageData(0,0,a,t),updateData(imgData.data,a,t)}var gui=new dat.GUI;function updateDataWhenChange(){imgData&&updateData(imgData.data,imgData.width,imgData.height)}gui.add(config,"scale",-1,1).onFinishChange(updateDataWhenChange),gui.add(config,"colorContrast",0,2).onFinishChange(updateDataWhenChange),gui.add(config,"sameColor").onChange(updateDataWhenChange),gui.addColor(config,"color").onChange(updateDataWhenChange),["roughness","metalness"].forEach(function(e){gui.add(config,e,0,1).step(.01).onFinishChange(function(){myChart.setOption({series:[{realisticMaterial:{roughness:config.roughness,metalness:config.metalness}}]})})});function updateControlAndLight(){myChart.setOption({grid3D:{environment:config.showEnvironment?"auto":"#000",viewControl:{panSensitivity:config.move?1:0,rotateSensitivity:config.lockY?[1,0]:1},light:{main:{intensity:config.lightIntensity,color:config.lightColor,alpha:config.lightPitch,beta:config.lightRotate},ambientCubemap:{texture:"/asset/get/s/data-1491838644249-ry33I7YTe.hdr"}},postEffect:{screenSpaceAmbientOcclusion:{intensity:config.AO}}}})}gui.add(config,"lightIntensity",0,10).onChange(updateControlAndLight),gui.add(config,"lightRotate",-180,180).onChange(updateControlAndLight),gui.add(config,"lightPitch",10,90).onChange(updateControlAndLight),gui.add(config,"barNumber",0,256).onFinishChange(function(){loadImage(currentImg)}),gui.add(config,"barSize",0,2).onFinishChange(function(){myChart.setOption({series:[{barSize:config.barSize}]})}),gui.add(config,"barBevel",0,1).onFinishChange(function(){myChart.setOption({series:[{bevelSize:config.barBevel}]})}),gui.add(config,"depthOfField",0,10).onFinishChange(function(){myChart.setOption({grid3D:{postEffect:{depthOfField:{blurRadius:config.depthOfField}}}})});function readFile(e){if(!(!e||!e.type.match(/image/))){var t=new FileReader;t.onload=function(o){img=new Image,img.onload=function(){loadImage(img),currentImg=img},img.src=o.target.result},t.readAsDataURL(e)}}$('<div id="image-upload">Drop files here or click to upload</div>').appendTo($("#chart-panel")).css({width:"300px",height:"100px","line-height":"100px","text-align":"center",cursor:"pointer",background:"rgba(255, 255, 255, 0.2)","border-radius":"4px",border:"2px dashed #999",position:"absolute",right:"10px",bottom:"10px","z-index":"10",color:"#fff"}),$("#image-upload").on("dragover",function(e){e.stopPropagation(),e.preventDefault()}),$("#image-upload")[0].addEventListener("drop",function(e){e.stopPropagation(),e.preventDefault();var t=e.dataTransfer.files;return readFile(t[0])}),$("#image-upload").on("click",function(){var e=$('<input type="file" />');e.on("change",function(t){readFile(t.target.files[0])}),e.click()});var img=new Image;img.onload=function(){loadImage(img),currentImg=img},img.src="/asset/get/s/data-1502210091353-S1mNuDPDW.png";
