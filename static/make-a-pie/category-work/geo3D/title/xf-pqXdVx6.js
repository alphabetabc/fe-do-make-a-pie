var chart=echarts.init(document.getElementById("chart-panel"));function loadJSON(){var N,A,k,q,j,B,b;a=myChart,a.showLoading(),N=$(".panel").find("option:selected").last(),N.attr("selected",!0),A=N.val().split("|"),k=A[0],q=A[1],j=N.text(),B={subdistrict:1,extensions:"all"},b=new AMap.DistrictSearch(B),b.setSubdistrict(1),b.setLevel(k),b.search(j,function(U,O){function J(){this.type="FeatureCollection",this.features=[]}function D(){this.type="Feature",this.id="",this.properties={name:"",cp:[],childNum:1},this.geometry={type:"Polygon",coordinates:[]}}function T(e,s){var n,t,r,i=[],o=[],m=[],u=e.boundaries.length;if(u===1){for(n=e.boundaries[0],t=0;t<n.length;t++)i[0]=n[t].lng,i[1]=n[t].lat,o.push(i),i=[];s.push(o)}else for(r=0;u>r;r++){for(n=e.boundaries[r],t=0;t<n.length;t++)i[0]=n[t].lng,i[1]=n[t].lat,o.push(i),i=[];m.push(o),o=[],s.push(m),m=[]}}function Q(e){e.UTF8Encoding=!0;var s=e.features;return s?(s.forEach(function(n){var t=n.geometry.encodeOffsets=[],r=n.geometry.coordinates;n.geometry.type==="Polygon"?r.forEach(function(i,o){r[o]=K(i,t[o]=[])}):n.geometry.type==="MultiPolygon"&&r.forEach(function(i,o){t[o]=[],i.forEach(function(m,u){r[o][u]=K(m,t[o][u]=[])})})}),e):void 0}function K(e,s){var n,t,r="",i=F(e[0][0]),o=F(e[0][1]);for(s[0]=i,s[1]=o,n=0;n<e.length;n++)t=e[n],r+=R(t[0],i),r+=R(t[1],o),i=F(t[0]),o=F(t[1]);return r}function F(e){return Math.ceil(1024*e)}function R(e,s){return e=F(e),e-=s,64+(e<<1^e>>15)==8232&&e--,e=e<<1^e>>15,String.fromCharCode(e+64)}function _(e,s,n){var t,r,i,o=new J,m=o.features,u=e[0],P=u.districtList,g=u.citycode,c=0;if(g.length)for(t=0,r=P.length;r>t;t++)c++,b.search(P[t].name,function(l,h){function S(d,f){var p,y,x,E,v,M;for(p=new D,y=[],x=[],E=0,v=d.length;v>E;E++)if(M=d[E],M.citycode===f)return p.id=M.adcode,p.properties.name=M.name,p.properties.childNum=M.boundaries.length,p.properties.childNum>1&&(p.geometry.type="MultiPolygon"),y[0]=M.center.lng,y[1]=M.center.lat,p.properties.cp=y,y=[],T(M,x),p.geometry.coordinates=x,x=[],p}c--;var w=h.districtList,L=S(w,q);L&&m.push(L),c===0&&(s&&(o=Q(o)),n(o),b.setSubdistrict(1))});else for(t=0,r=P.length;r>t;t++)i=P[t].name,c++,b.search(i,function(l,h){function S(d){var f,p,y,x,E,v;for(f=new D,p=[],y=[],x=0,E=d.length;E>x;x++)return v=d[x],f.id=v.adcode,f.properties.name=v.name,f.properties.childNum=v.boundaries.length,f.properties.childNum>1&&(f.geometry.type="MultiPolygon"),p[0]=v.center.lng,p[1]=v.center.lat,f.properties.cp=p,p=[],T(v,y),f.geometry.coordinates=y,y=[],f}c--;var w=h.districtList,L=S(w);m.push(L),c===0&&(o=Q(o),n(o),b.setSubdistrict(1))})}function z(e,s,n){function t(g,c){var l,h,S,w,L,d;for(l=new D,h=[],S=[],w=0,L=g.length;L>w;w++)if(d=g[w],d.citycode==c)return l.id=d.adcode,l.properties.name=d.name,l.properties.childNum=d.boundaries.length,l.properties.childNum>1&&(l.geometry.type="MultiPolygon"),h[0]=d.center.lng,h[1]=d.center.lat,l.properties.cp=h,h=[],T(d,S),l.geometry.coordinates=S,l}function r(g){var c=new D,l=[],h=[];return c.id=g.adcode,c.properties.name=g.name,c.properties.childNum=g.boundaries.length,c.properties.childNum>1&&(c.geometry.type="MultiPolygon"),l[0]=g.center.lng,l[1]=g.center.lat,c.properties.cp=l,l=[],T(g,h),c.geometry.coordinates=h,c}var i,o=new J,m=o.features,u=e[0],P=(u.citycode,u.level);i=P==="district"?t(e,q):r(u),m.push(i),s&&(o=Q(o)),n(o),b.setSubdistrict(1)}function W(e){var s=e.features.map(function(n){return{name:n.properties.name,height:2*Math.random()+1}});echarts.registerMap("mapArea",e),$("#"+a.getDom().id).contextmenu(function(){return!1}),a.clear(),a.setOption({color:["#dd6b66","#759aa0","#e69d87","#8dc1a9","#ea7e53","#eedd78","#73a373","#73b9bc","#7289ab","#91ca8c","#f49f42"],backgroundColor:"#333",textStyle:{color:"#eee",fontFamily:"Microsoft YaHei",fontSize:12,fontStyle:"normal",fontWeight:"normal"},title:{text:$(".panel select:eq(-2) option:selected").text(),textStyle:{color:"#fff"}},geo3D:{map:"mapArea",environment:"/asset/get/s/data-1491837999815-H1_44Qtal.jpg",itemStyle:{borderColor:"rgba(100,149,237,1)",borderWidth:1.5},shading:"lambert",lambertMaterial:{baseTexture:"/asset/get/s/data-1491896059428-B1QbPbq6e.jpg",textureTiling:20},regions:s}}),a.on("geoselectchanged",function(n){$(".panel select:last-child option").each(function(){return $(this).text()==n.batch[0].name?($(this).attr("selected",!0),void loadJSON()):void 0})}),a.getZr().on("mousedown",function(n){switch(n.event.which){case 3:$(".panel select").length>2&&($(".panel select:last-child").remove(),$(".panel select:last-child").remove(),loadJSON())}}),a.hideLoading()}switch(k){case"district":case"biz_area":z(O.districtList,!0,W);break;case"city":case"province":_(O.districtList,!0,W);default:var C=$("<select></select>");switch(C.change(function(){$(this).nextAll().remove(),$(this).val()||$(this).remove(),loadJSON()}),C.appendTo($(".panel")),k){case"country":C.append($('<option value="">--  所有省(行政区,直辖市)  --</option>'));break;case"province":C.append($('<option value="">--  所有城市  --</option>'));break;case"city":C.append($('<option value="">--  所有区县  --</option>'))}O.districtList[0].districtList.forEach(function(e){C.append($('<option value="'+e.level+(e.citycode?"|"+e.citycode:"")+'">'+e.name+"</option>"))}),k=="country"&&($(".panel").find("option").last().attr("selected",!0),loadJSON())}})}chart.on("click",function(N){alert("click"),loadMap(N.name,10)}),$("body").append($('<div class="panel" style="position: absolute;background-color: #fff;border: solid 1px silver;box-shadow: 3px 4px 3px 0px silver;right: 10px;top: 10px;padding: 5px 10px;font-size: 12px;border-radius: 4px">请选择区域：<select><option selected="selected" value="country">中国</option></select></div>')),loadJSON();
